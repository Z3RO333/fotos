<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Formul√°rio de Relat√≥rio de Visita T√©cnica - Sistema otimizado e acess√≠vel">
    <title>Relat√≥rio de Visita T√©cnica</title>
    <style>
        /* ==================== RESET E VARI√ÅVEIS ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Cores principais */
            --primary-color: #1a2f4d;
            --primary-dark: #0d1b2a;
            --primary-light: #2a4365;

            /* Cores de status */
            --success-color: #28a745;
            --success-bg: #d4edda;
            --warning-color: #ffc107;
            --warning-bg: #fff3cd;
            --danger-color: #dc3545;
            --danger-bg: #f8d7da;

            /* Cores neutras */
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;

            /* Escala tipogr√°fica (Major Third 1.25) */
            --font-xs: 12px;
            --font-sm: 14px;
            --font-base: 16px;
            --font-lg: 20px;
            --font-xl: 24px;
            --font-2xl: 30px;

            /* Espa√ßamentos */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;

            /* Bordas */
            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 10px;

            /* Transi√ß√µes */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;

            /* Sombras */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* ==================== BACKGROUND SIMPLIFICADO ==================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1B2735 0%, #090A0F 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: var(--spacing-lg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Background est√°tico simplificado */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(2px 2px at 80% 10%, white, transparent),
                radial-gradient(1px 1px at 90% 60%, white, transparent);
            background-size: 200% 200%;
            opacity: 0.2;
            pointer-events: none;
            z-index: 0;
        }

        /* ==================== LAYOUT PRINCIPAL ==================== */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-xl);
            text-align: center;
            position: relative;
        }

        .header-logo {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 60px;
            height: 60px;
            opacity: 0.9;
            transition: transform var(--transition-normal);
        }

        .header-logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .header h1 {
            font-size: clamp(20px, 5vw, var(--font-2xl));
            margin-bottom: var(--spacing-sm);
            padding-right: 70px;
        }

        .header p {
            font-size: var(--font-sm);
            opacity: 0.9;
        }

        /* ==================== INDICADOR DE SE√á√ïES ==================== */
        .section-indicator {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: white;
            border-bottom: 1px solid var(--border-color);
            gap: var(--spacing-xs);
            overflow-x: auto;
        }

        .step {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: var(--spacing-sm);
            font-size: var(--font-xs);
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .step.active {
            color: var(--primary-color);
            font-weight: 600;
            border-bottom-color: var(--primary-color);
        }

        .step.completed {
            color: var(--success-color);
        }

        /* ==================== INDICADOR DE PROGRESSO ==================== */
        .progress-container {
            background: var(--bg-light);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            transition: width 0.4s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
            line-height: 1.4;
        }

        .progress-text strong {
            color: var(--text-primary);
        }

        /* ==================== CONTE√öDO DO FORMUL√ÅRIO ==================== */
        .form-content {
            padding: var(--spacing-xl);
        }

        .section {
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--bg-light);
        }

        .section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            font-size: var(--font-lg);
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .section-icon {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: var(--font-sm);
            margin-bottom: var(--spacing-md);
        }

        /* ==================== CAMPOS DO FORMUL√ÅRIO ==================== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        label.required::after {
            content: " *";
            color: var(--danger-color);
        }

        .field-hint {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }

        /* Inputs comuns */
        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--font-base);
            font-family: inherit;
            transition: all var(--transition-normal);
            background: var(--bg-white);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 47, 77, 0.1);
        }

        input:hover:not(:focus),
        select:hover:not(:focus),
        textarea:hover:not(:focus) {
            border-color: var(--primary-light);
        }

        /* Valida√ß√£o visual */
        .form-group.invalid input,
        .form-group.invalid select,
        .form-group.invalid textarea {
            border-color: var(--danger-color);
        }

        .form-group.valid input,
        .form-group.valid select,
        .form-group.valid textarea {
            border-color: var(--success-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: var(--font-xs);
            margin-top: 4px;
            display: none;
        }

        .form-group.invalid .error-message {
            display: block;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        #observacoes,
        #acoesNecessarias {
            min-height: 150px;
        }

        /* ==================== SELETOR DE STATUS ==================== */
        .status-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .status-option {
            padding: var(--spacing-md);
            border: 3px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--bg-white);
            box-shadow: 0 0 0 0px transparent;
        }

        .status-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .status-option input[type="radio"] {
            display: none;
        }

        .status-option.ok { border-color: var(--success-color); }
        .status-option.atencao { border-color: var(--warning-color); }
        .status-option.critico { border-color: var(--danger-color); }

        .status-option.ok:has(input:checked) {
            background: var(--success-bg);
            box-shadow: 0 0 0 1px var(--success-color), 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .status-option.atencao:has(input:checked) {
            background: var(--warning-bg);
            box-shadow: 0 0 0 1px var(--warning-color), 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .status-option.critico:has(input:checked) {
            background: var(--danger-bg);
            box-shadow: 0 0 0 1px var(--danger-color), 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .status-icon {
            font-size: 32px;
            margin-bottom: var(--spacing-xs);
        }

        .status-label {
            font-weight: 600;
            font-size: var(--font-sm);
        }

        /* ==================== CATEGORIAS COM UPLOAD ==================== */
        .categoria-item {
            margin-bottom: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
            background: var(--bg-white);
        }

        .categoria-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .categoria-header {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-light);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .categoria-header:hover {
            background: #e9ecef;
        }

        .categoria-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--spacing-sm);
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .categoria-header label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-sm);
            flex: 1;
        }

        .categoria-content {
            padding: var(--spacing-md);
            background: var(--bg-white);
            border-top: 2px solid var(--border-color);
            display: none;
        }

        .categoria-content.active {
            display: block;
        }

        /* Upload de fotos por categoria */
        .mini-upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            text-align: center;
            background: var(--bg-light);
            cursor: pointer;
            transition: all var(--transition-normal);
            margin-top: var(--spacing-sm);
        }

        .mini-upload-area:hover {
            background: #e2e8f0;
            transform: scale(1.01);
        }

        .foto-preview-mini {
            display: grid;
            grid-template-columns: repeat(auto-fill, 100px);
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .foto-item {
            position: relative;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            transition: all var(--transition-fast);
        }

        .foto-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .foto-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #c82333;
            transform: scale(1.1) rotate(90deg);
        }

        /* Upload de fotos gerais */
        .file-upload-area {
            border: 3px dashed var(--primary-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            background: var(--bg-light);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .file-upload-area:hover {
            background: #e2e8f0;
            transform: scale(1.01);
        }

        .file-upload-area.drag-over {
            background: #d5d9ff;
            border-color: var(--primary-dark);
        }

        .foto-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, 180px);
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .foto-preview-item {
            position: relative;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            background: var(--bg-white);
            transition: all var(--transition-normal);
        }

        .foto-preview-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .foto-preview-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }

        .foto-info {
            padding: var(--spacing-sm);
            background: var(--bg-light);
        }

        .foto-info input {
            width: 100%;
            padding: var(--spacing-xs);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-xs);
            transition: all var(--transition-fast);
        }

        .remove-foto {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .remove-foto:hover {
            background: #c82333;
            transform: scale(1.1) rotate(90deg);
        }

        /* ==================== BOT√ïES ==================== */
        .btn-submit {
            width: 100%;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius-lg);
            font-size: var(--font-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-submit:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            text-align: center;
            max-width: 400px;
            margin: var(--spacing-md);
        }

        .spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--spacing-sm);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================== MODAL DE CONFIRMA√á√ÉO ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-xl);
        }

        .summary {
            background: var(--bg-light);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-lg);
        }

        .summary p {
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-sm);
        }

        .summary strong {
            color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        .btn-secondary,
        .btn-primary {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* ==================== ALERTAS ==================== */
        .alert {
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            display: none;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: var(--success-bg);
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .alert-error {
            background: var(--danger-bg);
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        /* ==================== RESPONSIVIDADE ==================== */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }

            .header {
                padding: var(--spacing-lg);
            }

            .header h1 {
                font-size: 20px;
                padding-right: 70px;
            }

            .header-logo {
                width: 45px;
                height: 45px;
                right: 15px;
                top: 15px;
            }

            .form-content {
                padding: var(--spacing-lg);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .status-selector {
                grid-template-columns: 1fr;
            }

            .foto-preview-container {
                grid-template-columns: repeat(auto-fill, 140px);
            }

            .progress-bar {
                height: 12px;
            }

            .section-indicator {
                padding: var(--spacing-sm);
            }

            .step {
                font-size: 11px;
                padding: var(--spacing-xs);
            }
        }

        @media (max-width: 480px) {
            .section-title {
                font-size: var(--font-lg);
            }

            .foto-preview-mini {
                grid-template-columns: repeat(auto-fill, 80px);
            }
        }

        /* ==================== ACESSIBILIDADE ==================== */
        *:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABE√áALHO -->
        <header class="header" role="banner">
            <svg class="header-logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"
                 aria-label="√çcone capacete de seguran√ßa" role="img">
                <path fill="#1d56c2" d="M22 55c0-21 17-38 38-38s38 17 38 38v10H22Z"/>
                <rect fill="#1d56c2" x="18" y="55" width="84" height="10" rx="4"/>
                <rect fill="#1d56c2" x="52" y="10" width="16" height="22" rx="4"/>
                <path fill="#1d56c2" fill-rule="evenodd" d="M24 70a36 36 0 0 0 72 0H24Zm12 0a24 24 0 0 0 48 0H36Z"/>
                <rect fill="#1d56c2" x="28" y="42" width="12" height="10" rx="3"/>
                <rect fill="#1d56c2" x="80" y="42" width="12" height="10" rx="3"/>
            </svg>

            <h1>Relat√≥rio de Visita T√©cnica</h1>
            <p>Preencha todos os campos obrigat√≥rios (*)</p>
        </header>

        <!-- INDICADOR DE SE√á√ïES -->
        <div class="section-indicator" role="navigation" aria-label="Se√ß√µes do formul√°rio">
            <div class="step active" id="step-1">1. Unidade</div>
            <div class="step" id="step-2">2. Visita</div>
            <div class="step" id="step-3">3. Avalia√ß√£o</div>
            <div class="step" id="step-4">4. A√ß√µes</div>
            <div class="step" id="step-5">5. Fotos</div>
        </div>

        <!-- INDICADOR DE PROGRESSO -->
        <div class="progress-container" role="region" aria-label="Indicador de progresso do formul√°rio">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">
                <strong>0% completo</strong> ‚Ä¢ Preencha os campos obrigat√≥rios para continuar
            </div>
        </div>

        <!-- CONTE√öDO DO FORMUL√ÅRIO -->
        <main class="form-content">
            <div id="alertContainer" role="alert" aria-live="polite"></div>

            <form id="formVisita" novalidate>
                <!-- SE√á√ÉO 1: DADOS DA UNIDADE -->
                <section class="section" aria-labelledby="section1-title" data-section="1">
                    <h2 class="section-title" id="section1-title">
                        Informa√ß√µes da Unidade
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="codigoLoja" class="required">C√≥digo da Loja</label>
                            <input
                                type="text"
                                id="codigoLoja"
                                name="codigoLoja"
                                placeholder="Ex: LJ-089"
                                aria-required="true"
                                aria-describedby="codigoLoja-hint codigoLoja-error"
                                required>
                            <span class="field-hint" id="codigoLoja-hint">Digite o c√≥digo √∫nico da loja</span>
                            <span class="error-message" id="codigoLoja-error" role="alert"></span>
                        </div>

                        <div class="form-group">
                            <label for="nomeLoja" class="required">Nome da Unidade</label>
                            <input
                                type="text"
                                id="nomeLoja"
                                name="nomeLoja"
                                placeholder="Ex: Bemol Manaus Centro"
                                aria-required="true"
                                aria-describedby="nomeLoja-hint nomeLoja-error"
                                required>
                            <span class="field-hint" id="nomeLoja-hint">Nome completo da unidade visitada</span>
                            <span class="error-message" id="nomeLoja-error" role="alert"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade" class="required">Cidade</label>
                            <input
                                type="text"
                                id="cidade"
                                name="cidade"
                                placeholder="Ex: Manaus"
                                aria-required="true"
                                aria-describedby="cidade-error"
                                required>
                            <span class="error-message" id="cidade-error" role="alert"></span>
                        </div>

                        <div class="form-group">
                            <label for="tipoUnidade" class="required">Tipo de Unidade</label>
                            <select
                                id="tipoUnidade"
                                name="tipoUnidade"
                                aria-required="true"
                                aria-describedby="tipoUnidade-error"
                                required>
                                <option value="">Selecione o tipo...</option>
                                <option value="Loja">Loja</option>
                                <option value="CD">Centro de Distribui√ß√£o</option>
                                <option value="Farmacia">Farm√°cia</option>
                                <option value="Matriz">Matriz</option>
                            </select>
                            <span class="error-message" id="tipoUnidade-error" role="alert"></span>
                        </div>
                    </div>
                </section>

                <!-- SE√á√ÉO 2: DADOS DA VISITA -->
                <section class="section" aria-labelledby="section2-title" data-section="2">
                    <h2 class="section-title" id="section2-title">
                        Dados da Visita
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeVisitante" class="required">Nome do Visitante</label>
                            <input
                                type="text"
                                id="nomeVisitante"
                                name="nomeVisitante"
                                placeholder="Seu nome completo"
                                aria-required="true"
                                aria-describedby="nomeVisitante-hint nomeVisitante-error"
                                required>
                            <span class="field-hint" id="nomeVisitante-hint">Pessoa respons√°vel pela visita t√©cnica</span>
                            <span class="error-message" id="nomeVisitante-error" role="alert"></span>
                        </div>

                        <div class="form-group">
                            <label for="emailVisitante" class="required">E-mail</label>
                            <input
                                type="email"
                                id="emailVisitante"
                                name="emailVisitante"
                                placeholder="seu.email@empresa.com"
                                aria-required="true"
                                aria-describedby="emailVisitante-hint emailVisitante-error"
                                required>
                            <span class="field-hint" id="emailVisitante-hint">E-mail para receber c√≥pia do relat√≥rio</span>
                            <span class="error-message" id="emailVisitante-error" role="alert"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="area" class="required">√Årea Respons√°vel</label>
                            <select
                                id="area"
                                name="area"
                                aria-required="true"
                                aria-describedby="area-error"
                                required>
                                <option value="">Selecione a √°rea...</option>
                                <option value="Facilities">Facilities</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="TI">TI</option>
                                <option value="Seguran√ßa">Seguran√ßa</option>
                                <option value="Qualidade">Qualidade</option>
                            </select>
                            <span class="error-message" id="area-error" role="alert"></span>
                        </div>

                        <div class="form-group">
                            <label for="tipoVisita" class="required">Tipo de Visita</label>
                            <select
                                id="tipoVisita"
                                name="tipoVisita"
                                aria-required="true"
                                aria-describedby="tipoVisita-error"
                                required>
                                <option value="">Selecione o tipo...</option>
                                <option value="Inspe√ß√£o Mensal">Inspe√ß√£o Mensal</option>
                                <option value="Checklist">Checklist</option>
                                <option value="P√≥s-Obra">P√≥s-Obra</option>
                                <option value="Auditoria">Auditoria</option>
                                <option value="Emerg√™ncia">Emerg√™ncia</option>
                            </select>
                            <span class="error-message" id="tipoVisita-error" role="alert"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataVisita" class="required">Data da Visita</label>
                            <input
                                type="date"
                                id="dataVisita"
                                name="dataVisita"
                                aria-required="true"
                                aria-describedby="dataVisita-error"
                                required>
                            <span class="error-message" id="dataVisita-error" role="alert"></span>
                        </div>

                        <div class="form-group">
                            <label for="horaVisita" class="required">Hora da Visita</label>
                            <input
                                type="time"
                                id="horaVisita"
                                name="horaVisita"
                                aria-required="true"
                                aria-describedby="horaVisita-error"
                                required>
                            <span class="error-message" id="horaVisita-error" role="alert"></span>
                        </div>
                    </div>
                </section>

                <!-- SE√á√ÉO 3: AVALIA√á√ÉO -->
                <section class="section" aria-labelledby="section3-title" data-section="3">
                    <h2 class="section-title" id="section3-title">
                        Avalia√ß√£o Geral
                    </h2>

                    <div class="form-group">
                        <label class="required">Status Geral da Unidade</label>
                        <div class="status-selector" role="radiogroup" aria-required="true" aria-describedby="statusGeral-error">
                            <div class="status-option ok" tabindex="0" role="radio" aria-checked="false">
                                <input type="radio" id="statusOk" name="statusGeral" value="OK" required>
                                <label for="statusOk">
                                    <div class="status-icon" aria-hidden="true">‚úì</div>
                                    <div class="status-label">OK</div>
                                </label>
                            </div>

                            <div class="status-option atencao" tabindex="0" role="radio" aria-checked="false">
                                <input type="radio" id="statusAtencao" name="statusGeral" value="Aten√ß√£o">
                                <label for="statusAtencao">
                                    <div class="status-icon" aria-hidden="true">‚ö†</div>
                                    <div class="status-label">Aten√ß√£o</div>
                                </label>
                            </div>

                            <div class="status-option critico" tabindex="0" role="radio" aria-checked="false">
                                <input type="radio" id="statusCritico" name="statusGeral" value="Cr√≠tico">
                                <label for="statusCritico">
                                    <div class="status-icon" aria-hidden="true">‚úï</div>
                                    <div class="status-label">Cr√≠tico</div>
                                </label>
                            </div>
                        </div>
                        <span class="error-message" id="statusGeral-error" role="alert"></span>
                    </div>

                    <div class="form-group">
                        <label>Pontos Avaliados</label>
                        <span class="section-description">Selecione os itens avaliados, adicione observa√ß√µes e fotos</span>

                        <!-- Sistema El√©trico -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto1" tabindex="0">
                                <input type="checkbox" id="ponto1" name="pontosAvaliados" value="Sistema El√©trico" aria-label="Avaliar Sistema El√©trico">
                                <label for="ponto1">Sistema El√©trico</label>
                            </div>
                            <div class="categoria-content" id="content-ponto1">
                                <label for="obs-ponto1" class="sr-only">Observa√ß√µes sobre Sistema El√©trico</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Sistema El√©trico (ex: estado dos quadros, fia√ß√£o exposta, problemas identificados)..."
                                    id="obs-ponto1"
                                    rows="2"
                                    aria-describedby="obs-ponto1-hint"></textarea>
                                <span class="field-hint" id="obs-ponto1-hint">Descreva o estado geral e problemas encontrados</span>

                                <div class="mini-upload-area" data-categoria="ponto1" role="button" tabindex="0" aria-label="Adicionar fotos do Sistema El√©trico">
                                    <input type="file" id="foto-ponto1" accept="image/*" multiple aria-label="Selecionar fotos do Sistema El√©trico">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto1" aria-label="Fotos do Sistema El√©trico"></div>
                            </div>
                        </div>

                        <!-- Climatiza√ß√£o -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto2" tabindex="0">
                                <input type="checkbox" id="ponto2" name="pontosAvaliados" value="Climatiza√ß√£o" aria-label="Avaliar Climatiza√ß√£o">
                                <label for="ponto2">Climatiza√ß√£o</label>
                            </div>
                            <div class="categoria-content" id="content-ponto2">
                                <label for="obs-ponto2" class="sr-only">Observa√ß√µes sobre Climatiza√ß√£o</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Climatiza√ß√£o (ex: temperatura ambiente, estado dos equipamentos, vazamentos)..."
                                    id="obs-ponto2"
                                    rows="2"></textarea>

                                <div class="mini-upload-area" data-categoria="ponto2" role="button" tabindex="0" aria-label="Adicionar fotos da Climatiza√ß√£o">
                                    <input type="file" id="foto-ponto2" accept="image/*" multiple aria-label="Selecionar fotos da Climatiza√ß√£o">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto2" aria-label="Fotos da Climatiza√ß√£o"></div>
                            </div>
                        </div>

                        <!-- Limpeza Geral -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto3" tabindex="0">
                                <input type="checkbox" id="ponto3" name="pontosAvaliados" value="Limpeza Geral" aria-label="Avaliar Limpeza Geral">
                                <label for="ponto3">Limpeza Geral</label>
                            </div>
                            <div class="categoria-content" id="content-ponto3">
                                <label for="obs-ponto3" class="sr-only">Observa√ß√µes sobre Limpeza</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Limpeza (ex: estado de conserva√ß√£o, √°reas sujas, necessidade de limpeza profunda)..."
                                    id="obs-ponto3"
                                    rows="2"></textarea>

                                <div class="mini-upload-area" data-categoria="ponto3" role="button" tabindex="0" aria-label="Adicionar fotos de Limpeza">
                                    <input type="file" id="foto-ponto3" accept="image/*" multiple aria-label="Selecionar fotos de Limpeza">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto3" aria-label="Fotos de Limpeza"></div>
                            </div>
                        </div>

                        <!-- Layout e Sinaliza√ß√£o -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto4" tabindex="0">
                                <input type="checkbox" id="ponto4" name="pontosAvaliados" value="Layout e Sinaliza√ß√£o" aria-label="Avaliar Layout e Sinaliza√ß√£o">
                                <label for="ponto4">Layout e Sinaliza√ß√£o</label>
                            </div>
                            <div class="categoria-content" id="content-ponto4">
                                <label for="obs-ponto4" class="sr-only">Observa√ß√µes sobre Layout e Sinaliza√ß√£o</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Layout e Sinaliza√ß√£o (ex: placas danificadas, vias obstru√≠das, melhorias necess√°rias)..."
                                    id="obs-ponto4"
                                    rows="2"></textarea>

                                <div class="mini-upload-area" data-categoria="ponto4" role="button" tabindex="0" aria-label="Adicionar fotos de Layout e Sinaliza√ß√£o">
                                    <input type="file" id="foto-ponto4" accept="image/*" multiple aria-label="Selecionar fotos de Layout e Sinaliza√ß√£o">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto4" aria-label="Fotos de Layout e Sinaliza√ß√£o"></div>
                            </div>
                        </div>

                        <!-- Equipamentos TI -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto5" tabindex="0">
                                <input type="checkbox" id="ponto5" name="pontosAvaliados" value="Equipamentos TI" aria-label="Avaliar Equipamentos TI">
                                <label for="ponto5">Equipamentos TI</label>
                            </div>
                            <div class="categoria-content" id="content-ponto5">
                                <label for="obs-ponto5" class="sr-only">Observa√ß√µes sobre Equipamentos TI</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Equipamentos TI (ex: computadores, servidores, rede, cabeamento)..."
                                    id="obs-ponto5"
                                    rows="2"></textarea>

                                <div class="mini-upload-area" data-categoria="ponto5" role="button" tabindex="0" aria-label="Adicionar fotos de Equipamentos TI">
                                    <input type="file" id="foto-ponto5" accept="image/*" multiple aria-label="Selecionar fotos de Equipamentos TI">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto5" aria-label="Fotos de Equipamentos TI"></div>
                            </div>
                        </div>

                        <!-- Seguran√ßa -->
                        <div class="categoria-item">
                            <div class="categoria-header" role="button" aria-expanded="false" aria-controls="content-ponto6" tabindex="0">
                                <input type="checkbox" id="ponto6" name="pontosAvaliados" value="Seguran√ßa" aria-label="Avaliar Seguran√ßa">
                                <label for="ponto6">Seguran√ßa</label>
                            </div>
                            <div class="categoria-content" id="content-ponto6">
                                <label for="obs-ponto6" class="sr-only">Observa√ß√µes sobre Seguran√ßa</label>
                                <textarea
                                    placeholder="Observa√ß√µes sobre Seguran√ßa (ex: c√¢meras, controle de acesso, extintores, sa√≠das de emerg√™ncia)..."
                                    id="obs-ponto6"
                                    rows="2"></textarea>

                                <div class="mini-upload-area" data-categoria="ponto6" role="button" tabindex="0" aria-label="Adicionar fotos de Seguran√ßa">
                                    <input type="file" id="foto-ponto6" accept="image/*" multiple aria-label="Selecionar fotos de Seguran√ßa">
                                    <div>üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto6" aria-label="Fotos de Seguran√ßa"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes Gerais</label>
                        <textarea
                            id="observacoes"
                            name="observacoes"
                            placeholder="Descreva detalhes adicionais da visita, pontos de aten√ß√£o gerais, contexto importante..."
                            aria-describedby="observacoes-hint"></textarea>
                        <span class="field-hint" id="observacoes-hint">Use este espa√ßo para informa√ß√µes que n√£o se encaixam nas categorias acima</span>
                    </div>
                </section>

                <!-- SE√á√ÉO 4: A√á√ïES NECESS√ÅRIAS -->
                <section class="section" aria-labelledby="section4-title" data-section="4">
                    <h2 class="section-title" id="section4-title">
                        A√ß√µes Necess√°rias
                    </h2>

                    <div class="form-group">
                        <label for="acoesNecessarias">Descreva as A√ß√µes Recomendadas</label>
                        <textarea
                            id="acoesNecessarias"
                            name="acoesNecessarias"
                            placeholder="Liste as a√ß√µes corretivas e preventivas que devem ser tomadas (uma por linha)..."
                            aria-describedby="acoesNecessarias-hint"></textarea>
                        <span class="field-hint" id="acoesNecessarias-hint">Seja espec√≠fico sobre o que precisa ser feito</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="prazo">Prazo Recomendado</label>
                            <input
                                type="text"
                                id="prazo"
                                name="prazo"
                                placeholder="Ex: 15 dias, 1 semana, imediato"
                                aria-describedby="prazo-hint">
                            <span class="field-hint" id="prazo-hint">Prazo sugerido para conclus√£o das a√ß√µes</span>
                        </div>

                        <div class="form-group">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia" selected>M√©dia</option>
                                <option value="Alta">Alta</option>
                                <option value="Cr√≠tica">Cr√≠tica</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- SE√á√ÉO 5: FOTOS GERAIS -->
                <section class="section" aria-labelledby="section5-title" data-section="5">
                    <h2 class="section-title" id="section5-title">
                        Fotos Gerais (Opcional)
                    </h2>
                    <p class="section-description">
                        Use esta se√ß√£o para fotos adicionais que n√£o se encaixam nas categorias espec√≠ficas acima
                    </p>

                    <div
                        class="file-upload-area"
                        id="fileUploadArea"
                        role="button"
                        tabindex="0"
                        aria-label="√Årea de upload de fotos gerais. Clique ou arraste fotos aqui">
                        <input
                            type="file"
                            id="fotosInput"
                            accept="image/*"
                            multiple
                            aria-label="Selecionar fotos gerais"
                            style="display: none;">
                        <div style="font-size: 50px; margin-bottom: 15px;" aria-hidden="true">üì∑</div>
                        <h3>Clique ou arraste fotos aqui</h3>
                        <p style="color: var(--text-secondary); margin-top: 10px;">Aceita JPG, PNG (m√°x 30 fotos)</p>
                    </div>

                    <div class="foto-preview-container" id="fotoPreviewContainer" aria-label="Pr√©-visualiza√ß√£o de fotos gerais"></div>
                </section>

                <!-- BOT√ÉO ENVIAR -->
                <button
                    type="submit"
                    class="btn-submit"
                    id="btnSubmit"
                    aria-label="Enviar relat√≥rio de visita t√©cnica">
                    Enviar Relat√≥rio
                </button>
            </form>
        </main>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay" role="dialog" aria-live="polite" aria-busy="false">
        <div class="loading-content">
            <div class="spinner" role="status" aria-label="Processando"></div>
            <p><strong>Enviando relat√≥rio...</strong></p>
            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 10px;">
                Isso pode levar alguns instantes. N√£o feche esta p√°gina.
            </p>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div class="modal-overlay" id="confirmModal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar envio do relat√≥rio?</h3>
            <div class="summary">
                <p><strong>Loja:</strong> <span id="summaryLoja"></span></p>
                <p><strong>Visitante:</strong> <span id="summaryVisitante"></span></p>
                <p><strong>Status:</strong> <span id="summaryStatus"></span></p>
                <p><strong>Categorias avaliadas:</strong> <span id="summaryCategorias"></span></p>
                <p><strong>Fotos anexadas:</strong> <span id="summaryFotos"></span></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="fecharModal()">Revisar</button>
                <button type="button" class="btn-primary" onclick="confirmarEnvio()">Enviar Agora</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ==================== CONFIGURA√á√ÉO ====================
         */
        const CONFIG = {
            webhookUrl: 'https://bemol.app.n8n.cloud/webhook/visita',
            maxFotos: 30,
            maxTamanhoFoto: 5 * 1024 * 1024,
            maxLarguraImagem: 1200,
            qualidadeCompressao: 0.85,
            autoSaveInterval: 30000,

            mensagens: {
                campoObrigatorio: 'Este campo √© obrigat√≥rio',
                emailInvalido: 'Por favor, digite um e-mail v√°lido',
                dataInvalida: 'A data n√£o pode ser no futuro',
                statusObrigatorio: 'Por favor, selecione o status geral da unidade',
                fotoTamanho: 'A foto {nome} excede o tamanho m√°ximo de 5MB',
                fotoTipo: 'O arquivo {nome} n√£o √© uma imagem v√°lida',
                maxFotos: 'M√°ximo de {max} fotos permitidas'
            }
        };

        /**
         * ==================== ESTADO DA APLICA√á√ÉO ====================
         */
        const AppState = {
            fotosGerais: [],
            fotosPorCategoria: {
                ponto1: [], ponto2: [], ponto3: [],
                ponto4: [], ponto5: [], ponto6: []
            },
            isSubmitting: false,
            autoSaveTimer: null
        };

        /**
         * ==================== UTILIT√ÅRIOS ====================
         */
        const Utils = {
            validarEmail(email) {
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email);
            },

            isImagemValida(file) {
                return file && file.type.startsWith('image/');
            },

            formatarMensagem(template, params) {
                return template.replace(/{(\w+)}/g, (match, key) => params[key] || match);
            },

            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            scrollTo(element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            },

            async comprimirImagem(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            if (width > CONFIG.maxLarguraImagem) {
                                height = (height * CONFIG.maxLarguraImagem) / width;
                                width = CONFIG.maxLarguraImagem;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            canvas.toBlob((blob) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(blob);
                            }, 'image/jpeg', CONFIG.qualidadeCompressao);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        };

        /**
         * ==================== AUTO-SAVE ====================
         */
        const AutoSave = {
            salvar() {
                try {
                    const formData = new FormData(document.getElementById('formVisita'));
                    const dados = Object.fromEntries(formData);

                    // Adicionar checkboxes de categorias
                    const categorias = [];
                    for (let i = 1; i <= 6; i++) {
                        if (document.getElementById(`ponto${i}`)?.checked) {
                            categorias.push(i);
                        }
                    }
                    dados.categorias = categorias;

                    localStorage.setItem('rascunho_visita', JSON.stringify(dados));
                    localStorage.setItem('rascunho_timestamp', new Date().toISOString());
                } catch (error) {
                    console.warn('Erro ao salvar rascunho:', error);
                }
            },

            restaurar() {
                try {
                    const rascunho = localStorage.getItem('rascunho_visita');
                    const timestamp = localStorage.getItem('rascunho_timestamp');

                    if (!rascunho) return;

                    const dataRascunho = new Date(timestamp);
                    const horasAtras = (Date.now() - dataRascunho) / (1000 * 60 * 60);

                    if (horasAtras > 24) {
                        this.limpar();
                        return;
                    }

                    const confirmacao = confirm(
                        `Encontramos um rascunho salvo em ${dataRascunho.toLocaleString()}.\n\nDeseja restaurar?`
                    );

                    if (confirmacao) {
                        const dados = JSON.parse(rascunho);

                        Object.keys(dados).forEach(key => {
                            if (key === 'categorias') return;

                            const campo = document.querySelector(`[name="${key}"]`);
                            if (campo) {
                                if (campo.type === 'radio') {
                                    const radio = document.querySelector(`[name="${key}"][value="${dados[key]}"]`);
                                    if (radio) radio.checked = true;
                                } else {
                                    campo.value = dados[key];
                                }
                            }
                        });

                        // Restaurar categorias
                        if (dados.categorias) {
                            dados.categorias.forEach(i => {
                                const checkbox = document.getElementById(`ponto${i}`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    checkbox.dispatchEvent(new Event('change'));
                                }
                            });
                        }

                        Progresso.atualizar();
                        Alert.mostrar('Rascunho restaurado com sucesso!', 'success');
                    } else {
                        this.limpar();
                    }
                } catch (error) {
                    console.warn('Erro ao restaurar rascunho:', error);
                    this.limpar();
                }
            },

            limpar() {
                localStorage.removeItem('rascunho_visita');
                localStorage.removeItem('rascunho_timestamp');
            },

            iniciar() {
                this.restaurar();

                AppState.autoSaveTimer = setInterval(() => {
                    this.salvar();
                }, CONFIG.autoSaveInterval);
            }
        };

        /**
         * ==================== VALIDA√á√ÉO ====================
         */
        const Validacao = {
            validarCampo(campo) {
                const formGroup = campo.closest('.form-group');
                const errorElement = document.getElementById(`${campo.id}-error`);
                let erro = '';

                if (campo.hasAttribute('required') && !campo.value.trim()) {
                    erro = CONFIG.mensagens.campoObrigatorio;
                } else if (campo.type === 'email' && campo.value && !Utils.validarEmail(campo.value)) {
                    erro = CONFIG.mensagens.emailInvalido;
                } else if (campo.type === 'date' && campo.value) {
                    const dataInformada = new Date(campo.value);
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    if (dataInformada > hoje) {
                        erro = CONFIG.mensagens.dataInvalida;
                    }
                }

                if (erro) {
                    formGroup.classList.add('invalid');
                    formGroup.classList.remove('valid');
                    if (errorElement) errorElement.textContent = erro;
                    return false;
                } else {
                    formGroup.classList.remove('invalid');
                    if (campo.value.trim()) {
                        formGroup.classList.add('valid');
                    }
                    if (errorElement) errorElement.textContent = '';
                    return true;
                }
            },

            validarStatusGeral() {
                const statusSelecionado = document.querySelector('input[name="statusGeral"]:checked');
                const errorElement = document.getElementById('statusGeral-error');

                if (!statusSelecionado) {
                    if (errorElement) errorElement.textContent = CONFIG.mensagens.statusObrigatorio;
                    return false;
                } else {
                    if (errorElement) errorElement.textContent = '';
                    return true;
                }
            },

            validarFormulario() {
                const camposObrigatorios = [
                    'codigoLoja', 'nomeLoja', 'cidade', 'tipoUnidade',
                    'nomeVisitante', 'emailVisitante', 'area', 'tipoVisita',
                    'dataVisita', 'horaVisita'
                ];

                let todosValidos = true;
                let primeiroCampoInvalido = null;

                for (const campoId of camposObrigatorios) {
                    const campo = document.getElementById(campoId);
                    if (campo && !this.validarCampo(campo)) {
                        todosValidos = false;
                        if (!primeiroCampoInvalido) {
                            primeiroCampoInvalido = campo;
                        }
                    }
                }

                if (!this.validarStatusGeral()) {
                    todosValidos = false;
                }

                if (primeiroCampoInvalido) {
                    Utils.scrollTo(primeiroCampoInvalido);
                }

                return todosValidos;
            }
        };

        /**
         * ==================== PROGRESSO PONDERADO ====================
         */
        const Progresso = {
            atualizar() {
                // Campos b√°sicos obrigat√≥rios (peso 40%)
                const camposBasicos = [
                    'codigoLoja', 'nomeLoja', 'cidade', 'tipoUnidade',
                    'nomeVisitante', 'emailVisitante', 'area', 'tipoVisita',
                    'dataVisita', 'horaVisita'
                ];

                let basicosPreenchidos = camposBasicos.filter(id =>
                    document.getElementById(id)?.value.trim()
                ).length;

                // Status geral (peso 20%)
                const statusPreenchido = document.querySelector('input[name="statusGeral"]:checked') ? 1 : 0;

                // Categorias avaliadas (peso 20%)
                const categoriasPreenchidas = Array.from(
                    document.querySelectorAll('[name="pontosAvaliados"]:checked')
                ).length;

                // A√ß√µes necess√°rias (peso 20%)
                const acoesPreenchidas = document.getElementById('acoesNecessarias')?.value.trim() ? 1 : 0;

                // Calcular percentual ponderado
                const percBasicos = (basicosPreenchidos / camposBasicos.length) * 40;
                const percStatus = statusPreenchido * 20;
                const percCategorias = Math.min(categoriasPreenchidas / 3, 1) * 20;
                const percAcoes = acoesPreenchidas * 20;

                const percentual = Math.round(percBasicos + percStatus + percCategorias + percAcoes);

                // Atualizar UI
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const progressBar = progressFill?.parentElement;

                if (progressFill) progressFill.style.width = `${percentual}%`;
                if (progressBar) progressBar.setAttribute('aria-valuenow', percentual);

                // Texto din√¢mico
                let textoAdicional = '';
                if (percentual < 40) {
                    textoAdicional = 'Preencha os campos obrigat√≥rios para continuar';
                } else if (percentual < 60) {
                    textoAdicional = 'Selecione o status geral da unidade';
                } else if (percentual < 80) {
                    textoAdicional = 'Avalie pelo menos 3 categorias';
                } else if (percentual < 100) {
                    textoAdicional = 'Descreva as a√ß√µes necess√°rias';
                } else {
                    textoAdicional = 'Formul√°rio completo! Pronto para enviar';
                }

                if (progressText) {
                    progressText.innerHTML = `<strong>${percentual}% completo</strong> ‚Ä¢ ${textoAdicional}`;
                }

                // Atualizar indicador de se√ß√µes
                this.atualizarSteps(percentual);
            },

            atualizarSteps(percentual) {
                const steps = document.querySelectorAll('.step');

                steps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');

                    if (index === 0 && percentual >= 20) step.classList.add('completed');
                    if (index === 1 && percentual >= 40) step.classList.add('completed');
                    if (index === 2 && percentual >= 60) step.classList.add('completed');
                    if (index === 3 && percentual >= 80) step.classList.add('completed');
                    if (index === 4 && percentual === 100) step.classList.add('completed');
                });

                // Marcar step atual
                if (percentual < 20) steps[0]?.classList.add('active');
                else if (percentual < 40) steps[1]?.classList.add('active');
                else if (percentual < 60) steps[2]?.classList.add('active');
                else if (percentual < 80) steps[3]?.classList.add('active');
                else if (percentual < 100) steps[4]?.classList.add('active');
            }
        };

        /**
         * ==================== UPLOAD DE FOTOS ====================
         */
        const Upload = {
            async processarFotosCategoria(files, categoria) {
                for (const file of files) {
                    if (!Utils.isImagemValida(file)) {
                        Alert.mostrar(
                            Utils.formatarMensagem(CONFIG.mensagens.fotoTipo, { nome: file.name }),
                            'error'
                        );
                        continue;
                    }

                    if (file.size > CONFIG.maxTamanhoFoto) {
                        Alert.mostrar(
                            Utils.formatarMensagem(CONFIG.mensagens.fotoTamanho, { nome: file.name }),
                            'error'
                        );
                        continue;
                    }

                    try {
                        const base64Comprimido = await Utils.comprimirImagem(file);
                        const foto = {
                            nome: file.name,
                            base64: base64Comprimido.split(',')[1],
                            preview: base64Comprimido
                        };

                        AppState.fotosPorCategoria[categoria].push(foto);
                    } catch (error) {
                        console.error('Erro ao processar foto:', error);
                        Alert.mostrar(`Erro ao processar ${file.name}`, 'error');
                    }
                }

                this.renderizarFotosCategoria(categoria);
            },

            renderizarFotosCategoria(categoria) {
                const container = document.getElementById(`preview-${categoria}`);
                if (!container) return;

                container.innerHTML = '';

                AppState.fotosPorCategoria[categoria].forEach((foto, index) => {
                    const div = document.createElement('div');
                    div.className = 'foto-item';
                    div.innerHTML = `
                        <button
                            type="button"
                            class="remove-btn"
                            onclick="Upload.removerFotoCategoria('${categoria}', ${index})"
                            aria-label="Remover foto ${foto.nome}">&times;</button>
                        <img src="${foto.preview}" alt="${foto.nome}">
                    `;
                    container.appendChild(div);
                });
            },

            removerFotoCategoria(categoria, index) {
                AppState.fotosPorCategoria[categoria].splice(index, 1);
                this.renderizarFotosCategoria(categoria);
            },

            async processarFotosGerais(files) {
                if (AppState.fotosGerais.length + files.length > CONFIG.maxFotos) {
                    Alert.mostrar(
                        Utils.formatarMensagem(CONFIG.mensagens.maxFotos, { max: CONFIG.maxFotos }),
                        'error'
                    );
                    return;
                }

                for (const file of files) {
                    if (!Utils.isImagemValida(file)) {
                        Alert.mostrar(
                            Utils.formatarMensagem(CONFIG.mensagens.fotoTipo, { nome: file.name }),
                            'error'
                        );
                        continue;
                    }

                    if (file.size > CONFIG.maxTamanhoFoto) {
                        Alert.mostrar(
                            Utils.formatarMensagem(CONFIG.mensagens.fotoTamanho, { nome: file.name }),
                            'error'
                        );
                        continue;
                    }

                    try {
                        const base64Comprimido = await Utils.comprimirImagem(file);
                        const foto = {
                            nome: file.name,
                            base64: base64Comprimido.split(',')[1],
                            comentario: '',
                            preview: base64Comprimido
                        };

                        AppState.fotosGerais.push(foto);
                    } catch (error) {
                        console.error('Erro ao processar foto:', error);
                        Alert.mostrar(`Erro ao processar ${file.name}`, 'error');
                    }
                }

                this.renderizarFotosGerais();
            },

            renderizarFotosGerais() {
                const container = document.getElementById('fotoPreviewContainer');
                if (!container) return;

                container.innerHTML = '';

                AppState.fotosGerais.forEach((foto, index) => {
                    const div = document.createElement('div');
                    div.className = 'foto-preview-item';
                    div.innerHTML = `
                        <button
                            type="button"
                            class="remove-foto"
                            onclick="Upload.removerFotoGeral(${index})"
                            aria-label="Remover foto ${foto.nome}">&times;</button>
                        <img src="${foto.preview}" alt="${foto.nome}">
                        <div class="foto-info">
                            <input
                                type="text"
                                placeholder="Coment√°rio da foto (opcional)"
                                value="${foto.comentario}"
                                onchange="Upload.atualizarComentario(${index}, this.value)"
                                aria-label="Coment√°rio para a foto ${foto.nome}">
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            removerFotoGeral(index) {
                AppState.fotosGerais.splice(index, 1);
                this.renderizarFotosGerais();
            },

            atualizarComentario(index, valor) {
                if (AppState.fotosGerais[index]) {
                    AppState.fotosGerais[index].comentario = valor;
                }
            }
        };

        /**
         * ==================== ALERTAS ====================
         */
        const Alert = {
            mostrar(mensagem, tipo = 'error') {
                const container = document.getElementById('alertContainer');
                if (!container) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} show`;
                alertDiv.textContent = mensagem;
                alertDiv.setAttribute('role', 'alert');

                container.innerHTML = '';
                container.appendChild(alertDiv);

                window.scrollTo({ top: 0, behavior: 'smooth' });

                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 300);
                }, 5000);
            }
        };

        /**
         * ==================== MODAL DE CONFIRMA√á√ÉO ====================
         */
        function mostrarModal() {
            const formData = new FormData(document.getElementById('formVisita'));

            document.getElementById('summaryLoja').textContent =
                `${formData.get('codigoLoja')} - ${formData.get('nomeLoja')}`;

            document.getElementById('summaryVisitante').textContent =
                `${formData.get('nomeVisitante')} (${formData.get('emailVisitante')})`;

            document.getElementById('summaryStatus').textContent =
                formData.get('statusGeral') || 'N√£o selecionado';

            const categorias = Array.from(document.querySelectorAll('[name="pontosAvaliados"]:checked'))
                .map(cb => cb.value);
            document.getElementById('summaryCategorias').textContent =
                categorias.length > 0 ? categorias.join(', ') : 'Nenhuma';

            const totalFotos = AppState.fotosGerais.length +
                Object.values(AppState.fotosPorCategoria).reduce((acc, arr) => acc + arr.length, 0);
            document.getElementById('summaryFotos').textContent = totalFotos;

            document.getElementById('confirmModal').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        async function confirmarEnvio() {
            fecharModal();
            await Form.enviarDados();
        }

        /**
         * ==================== SUBMISS√ÉO DO FORMUL√ÅRIO ====================
         */
        const Form = {
            montarJSON() {
                const formData = new FormData(document.getElementById('formVisita'));

                const pontosAvaliados = [];
                const categorias = {
                    ponto1: 'Sistema El√©trico',
                    ponto2: 'Climatiza√ß√£o',
                    ponto3: 'Limpeza Geral',
                    ponto4: 'Layout e Sinaliza√ß√£o',
                    ponto5: 'Equipamentos TI',
                    ponto6: 'Seguran√ßa'
                };

                for (let i = 1; i <= 6; i++) {
                    const checkbox = document.getElementById(`ponto${i}`);
                    if (checkbox?.checked) {
                        const categoria = `ponto${i}`;
                        const observacao = document.getElementById(`obs-${categoria}`)?.value || '';
                        const fotos = AppState.fotosPorCategoria[categoria].map(f => ({
                            nome: f.nome,
                            base64: f.base64
                        }));

                        pontosAvaliados.push({
                            item: categorias[categoria],
                            observacao: observacao || 'Sem observa√ß√µes.',
                            fotos: fotos
                        });
                    }
                }

                return {
                    id_resposta: `FORM-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    loja: {
                        codigo: formData.get('codigoLoja'),
                        nome: formData.get('nomeLoja'),
                        cidade: formData.get('cidade'),
                        tipo: formData.get('tipoUnidade'),
                        email: ''
                    },
                    visita: {
                        responsavel: formData.get('emailVisitante'),
                        nome_responsavel: formData.get('nomeVisitante'),
                        area: formData.get('area'),
                        data: formData.get('dataVisita'),
                        hora: formData.get('horaVisita'),
                        tipo_visita: formData.get('tipoVisita')
                    },
                    avaliacao: {
                        status_geral: formData.get('statusGeral'),
                        pontos_avaliados: pontosAvaliados,
                        observacoes: formData.get('observacoes') || 'Nenhuma observa√ß√£o adicional.'
                    },
                    acoes: {
                        necessarias: formData.get('acoesNecessarias') || 'Nenhuma a√ß√£o necess√°ria no momento.',
                        prazo: formData.get('prazo') || 'N/A',
                        prioridade: formData.get('prioridade')
                    },
                    fotos_gerais: AppState.fotosGerais.map(f => ({
                        nome: f.nome,
                        base64: f.base64,
                        comentario: f.comentario
                    })),
                    config: {
                        incluir_pdf: true,
                        template: 'padrao_visita'
                    }
                };
            },

            async enviarComRetry(dados, tentativas = 3) {
                for (let i = 0; i < tentativas; i++) {
                    try {
                        const response = await fetch(CONFIG.webhookUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(dados)
                        });

                        if (response.ok) return response;

                        if (i < tentativas - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                        }
                    } catch (error) {
                        if (i === tentativas - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                    }
                }
                throw new Error('Falha ap√≥s m√∫ltiplas tentativas');
            },

            async enviarDados() {
                if (AppState.isSubmitting) return;

                AppState.isSubmitting = true;
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.add('active');
                loadingOverlay.setAttribute('aria-busy', 'true');

                try {
                    const dados = this.montarJSON();
                    await this.enviarComRetry(dados);

                    loadingOverlay.classList.remove('active');
                    loadingOverlay.setAttribute('aria-busy', 'false');

                    Alert.mostrar('‚úÖ Relat√≥rio enviado com sucesso! Voc√™ receber√° um e-mail em breve.', 'success');

                    setTimeout(() => {
                        if (confirm('Deseja preencher outro relat√≥rio?')) {
                            this.limpar();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    }, 3000);

                    AutoSave.limpar();

                } catch (error) {
                    console.error('Erro ao enviar:', error);
                    loadingOverlay.classList.remove('active');
                    loadingOverlay.setAttribute('aria-busy', 'false');
                    Alert.mostrar('‚ùå Erro ao enviar relat√≥rio. Verifique sua conex√£o e tente novamente.', 'error');
                } finally {
                    AppState.isSubmitting = false;
                }
            },

            async enviar(e) {
                e.preventDefault();

                if (!Validacao.validarFormulario()) {
                    Alert.mostrar('Por favor, corrija os erros antes de enviar', 'error');
                    return;
                }

                mostrarModal();
            },

            limpar() {
                document.getElementById('formVisita').reset();

                AppState.fotosGerais = [];
                Upload.renderizarFotosGerais();

                for (let i = 1; i <= 6; i++) {
                    const categoria = `ponto${i}`;
                    AppState.fotosPorCategoria[categoria] = [];
                    Upload.renderizarFotosCategoria(categoria);

                    const content = document.getElementById(`content-${categoria}`);
                    if (content) {
                        content.classList.remove('active');
                        content.parentElement.querySelector('.categoria-header').setAttribute('aria-expanded', 'false');
                    }
                }

                document.querySelectorAll('.form-group').forEach(group => {
                    group.classList.remove('valid', 'invalid');
                });

                Progresso.atualizar();
            }
        };

        /**
         * ==================== INICIALIZA√á√ÉO ====================
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar auto-save
            AutoSave.iniciar();

            // Definir data e hora atuais
            const hoje = new Date();
            const dataInput = document.getElementById('dataVisita');
            const horaInput = document.getElementById('horaVisita');

            if (dataInput) dataInput.valueAsDate = hoje;
            if (horaInput) horaInput.value = hoje.toTimeString().slice(0, 5);

            // Valida√ß√£o em tempo real
            const camposObrigatorios = ['codigoLoja', 'nomeLoja', 'cidade', 'tipoUnidade',
                'nomeVisitante', 'emailVisitante', 'area', 'tipoVisita', 'dataVisita', 'horaVisita'];

            camposObrigatorios.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener('blur', () => Validacao.validarCampo(campo));
                    campo.addEventListener('input', () => {
                        if (campo.classList.contains('invalid')) {
                            Validacao.validarCampo(campo);
                        }
                        Progresso.atualizar();
                    });
                }
            });

            // Categorias
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`ponto${i}`);
                const header = checkbox?.closest('.categoria-header');
                const content = document.getElementById(`content-ponto${i}`);

                if (!checkbox || !header || !content) continue;

                const toggleCategoria = () => {
                    const isChecked = checkbox.checked;
                    content.classList.toggle('active', isChecked);
                    header.setAttribute('aria-expanded', isChecked);
                    Progresso.atualizar();
                };

                checkbox.addEventListener('change', toggleCategoria);

                header.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        toggleCategoria();
                    }
                });

                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        checkbox.checked = !checkbox.checked;
                        toggleCategoria();
                    }
                });

                // Upload por categoria
                const uploadArea = document.querySelector(`[data-categoria="ponto${i}"]`);
                const fileInput = document.getElementById(`foto-ponto${i}`);

                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', () => fileInput.click());

                    uploadArea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            fileInput.click();
                        }
                    });

                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            Upload.processarFotosCategoria(e.target.files, `ponto${i}`);
                        }
                    });
                }
            }

            // Status geral
            document.querySelectorAll('.status-option').forEach(option => {
                const radio = option.querySelector('input[type="radio"]');

                option.addEventListener('click', () => {
                    if (radio) {
                        radio.checked = true;
                        Validacao.validarStatusGeral();
                        Progresso.atualizar();

                        document.querySelectorAll('.status-option').forEach(opt => {
                            opt.setAttribute('aria-checked', 'false');
                        });
                        option.setAttribute('aria-checked', 'true');
                    }
                });

                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (radio) {
                            radio.checked = true;
                            Validacao.validarStatusGeral();
                            Progresso.atualizar();
                        }
                    }
                });

                if (radio) {
                    radio.addEventListener('change', () => {
                        Validacao.validarStatusGeral();
                        Progresso.atualizar();
                    });
                }
            });

            // Upload de fotos gerais
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fotosInput = document.getElementById('fotosInput');

            if (fileUploadArea && fotosInput) {
                fileUploadArea.addEventListener('click', () => fotosInput.click());

                fileUploadArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        fotosInput.click();
                    }
                });

                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('drag-over');
                });

                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('drag-over');
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('drag-over');
                    if (e.dataTransfer.files.length > 0) {
                        Upload.processarFotosGerais(e.dataTransfer.files);
                    }
                });

                fotosInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        Upload.processarFotosGerais(e.target.files);
                    }
                });
            }

            // Monitorar a√ß√µes necess√°rias para progresso
            const acoesTextarea = document.getElementById('acoesNecessarias');
            if (acoesTextarea) {
                acoesTextarea.addEventListener('input', () => {
                    Progresso.atualizar();
                });
            }

            // Submiss√£o do formul√°rio
            const form = document.getElementById('formVisita');
            if (form) {
                form.addEventListener('submit', (e) => Form.enviar(e));
            }

            // Progresso inicial
            Progresso.atualizar();
        });

        // Expor fun√ß√µes globalmente
        window.Upload = Upload;
        window.fecharModal = fecharModal;
        window.confirmarEnvio = confirmarEnvio;
    </script>
</body>
</html>
