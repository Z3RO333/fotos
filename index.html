<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Visita T√©cnica</title>
    <style>
        /* CSS organizado: vari√°veis, agrupamento l√≥gico e responsividade */
        :root{
            --bg-start: #0a1929;
            --bg-end: #1e3a5f;
            --primary-1: #0d47a1;
            --primary-2: #1565c0;
            --accent: #5e7ce2;
            --muted: #90a4ae;
            --card-bg: #ffffff;
            --input-bg: #fafbfc;
            --border: #c5cae9;
            --success-bg: #e8f5e9;
            --warning-bg: #fff3e0;
            --text: #1a237e;
            --shadow-lg: 0 25px 50px rgba(0,0,0,0.5);
        }

        /* Reset / Base */
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg,var(--bg-start) 0%,var(--bg-end) 100%);
            display:flex;align-items:flex-start;justify-content:center;min-height:100vh;padding:40px 20px;color:var(--text);
        }

        /* Layout principal */
        .container{
            width:100%;
            max-width:600px;
            background:var(--card-bg);
            border-radius:20px;
            margin:0 auto;
            max-height:calc(100vh - 48px);
            overflow:auto;
            box-shadow:var(--shadow-lg);
        }

        /* Header */
        .header{background:linear-gradient(135deg,var(--primary-1),var(--primary-2));padding:40px 30px;text-align:center}
        .logo{width:120px;height:120px;border-radius:50%;background:#fff;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,0.2);border:4px solid rgba(255,255,255,0.3);overflow:hidden}
        .logo img{width:90%;height:90%;object-fit:contain}
        h1{color:#fff;margin:15px 0 8px;font-size:28px;font-weight:700}
        .header-subtitle{color:rgba(255,255,255,0.9);font-size:14px}

        /* Form content */
        .form-content{padding:40px 35px}
        .section-title{font-size:18px;font-weight:600;color:var(--primary-1);margin:30px 0 25px;padding-bottom:12px;border-bottom:2px solid #e3f2fd;text-transform:uppercase}
        .upload-section{margin-bottom:30px}
        .upload-label{display:flex;align-items:center;font-weight:600;color:var(--text);margin-bottom:12px;font-size:15px}
        .upload-label .icon{width:32px;height:32px;background:#e3f2fd;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px}

        /* Inputs */
        .text-input,.textarea-input{width:100%;padding:14px 16px;font-size:15px;border:2px solid var(--border);border-radius:10px;background:var(--input-bg);color:var(--text);outline:none;transition:all .2s ease}
        .textarea-input{min-height:100px;resize:vertical}
        .text-input:focus,.textarea-input:focus{border-color:var(--accent);background:#fff}

        /* File input (visual) */
        .file-input-wrapper{position:relative}
        .file-input-wrapper input[type="file"]{position:absolute;left:-9999px}
        .file-input-label{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:25px 20px;background:var(--input-bg);border:2px dashed var(--border);border-radius:12px;cursor:pointer;transition:all .2s ease;text-align:center}
        .file-input-label:focus{outline:3px solid rgba(21,101,192,0.18);outline-offset:3px}
        .file-input-label:hover{border-color:var(--accent);background:#f0f4ff}
        .file-input-label.has-file{border-color:#43a047;background:#f1f8f4}
        .file-input-label .upload-icon{font-size:36px;margin-bottom:10px;color:var(--accent)}
        .file-input-label .upload-text{color:#546e7a;font-size:14px}
        .file-input-label .upload-hint{color:var(--muted);font-size:12px;margin-top:5px}

        /* File preview */
        .file-preview{margin-top:12px;padding:12px;background:#f5f7fa;border-radius:8px;font-size:13px;color:#2e7d32;display:none;font-weight:500}
        .file-preview.show{display:flex;flex-direction:column;gap:8px}
        .file-preview .files-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .file-preview .thumb{width:96px;height:72px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
        .file-preview .thumb img{width:100%;height:100%;object-fit:cover;display:block}
        .file-preview .file-info{font-size:13px;color:#37474f}

        /* Buttons / messages / footer */
        .submit-btn{width:100%;background:linear-gradient(135deg,var(--primary-1),var(--primary-2));color:#fff;border:none;padding:18px;border-radius:12px;font-weight:600;cursor:pointer;margin-top:35px;font-size:16px;text-transform:uppercase;transition:all .3s ease;box-shadow:0 6px 20px rgba(13,71,161,0.4)}
        .submit-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(13,71,161,0.6)}
        .submit-btn:disabled{background:#b0bec5;cursor:not-allowed;box-shadow:none}

        .loading,.success-message{display:none;text-align:center;margin-top:20px;padding:15px;border-radius:8px;font-weight:600}
        .loading.show,.success-message.show{display:block}
        .loading{background:#e3f2fd;color:var(--primary-1)}
        .success-message{background:var(--success-bg);color:#2e7d32}

        .footer{text-align:center;padding:25px;background:#f5f7fa;color:#78909c;font-size:13px;border-top:1px solid #eceff1}

        /* Responsividade */
        @media (max-width:480px){
            .form-content{padding:24px}
            .file-preview .thumb{width:72px;height:54px}
            h1{font-size:22px}
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">
            <img src="https://raw.githubusercontent.com/Z3RO333/fotos/refs/heads/main/image_1-removebg-preview.png" alt="Logo">
        </div>
        <h1>Relat√≥rio de Visita T√©cnica</h1>
        <p class="header-subtitle">Documenta√ß√£o de Servi√ßos Realizados</p>
    </div>

    <div class="form-content">
        <form id="uploadForm">
            
            <div class="upload-section">
                <div class="upload-label"><span class="icon">üè¨</span><span>Identifica√ß√£o da Loja</span></div>
                <input type="text" id="loja" class="text-input" placeholder="Ex: Loja 05 - Djalma Batista" required>
            </div>
            
            <div class="upload-section">
                <div class="upload-label"><span class="icon">üìÖ</span><span>Data da Visita</span></div>
                <input type="date" id="data_visita" class="text-input" required>
            </div>

            <div class="upload-section">
                <div class="upload-label"><span class="icon">üë§</span><span>Respons√°vel pela Visita</span></div>
                <input type="text" id="tecnico" class="text-input" placeholder="Seu nome completo" required>
            </div>

            <h2 class="section-title">ANEXAR EVID√äNCIAS FOTOGR√ÅFICAS</h2>

            <div class="upload-section">
                <div class="upload-label"><span class="icon">üé®</span><span>Servi√ßos de Pintura</span></div>
                <div class="file-input-wrapper">
                    <label for="fotos_pintura" class="file-input-label" tabindex="0" role="button" aria-controls="file-preview-pintura">
                        <span class="upload-icon">üì∑</span><span class="upload-text">Clique para selecionar imagens</span>
                    </label>
                    <input type="file" id="fotos_pintura" multiple accept="image/*">
                </div>
                <div class="file-preview" id="file-preview-pintura"></div>
                <div class="upload-label" style="margin-top: 15px;"><span class="icon">üìù</span><span>Observa√ß√µes - Pintura</span></div>
                <textarea id="obs_pintura" class="textarea-input" placeholder="Ex: √Årea com infiltra√ß√£o..."></textarea>
            </div>

            <div class="upload-section">
                <div class="upload-label"><span class="icon">üîß</span><span>Servi√ßos de Reparo</span></div>
                <div class="file-input-wrapper">
                    <label for="fotos_reparo" class="file-input-label" tabindex="0" role="button" aria-controls="file-preview-reparo">
                        <span class="upload-icon">üì∑</span><span class="upload-text">Clique para selecionar imagens</span>
                    </label>
                    <input type="file" id="fotos_reparo" multiple accept="image/*">
                </div>
                <div class="file-preview" id="file-preview-reparo"></div>
                <div class="upload-label" style="margin-top: 15px;"><span class="icon">üìù</span><span>Observa√ß√µes - Reparo</span></div>
                <textarea id="obs_reparo" class="textarea-input" placeholder="Ex: Porta danificada..."></textarea>
            </div>

            <div class="upload-section">
                <div class="upload-label"><span class="icon">üí°</span><span>Servi√ßos de Substitui√ß√£o</span></div>
                <div class="file-input-wrapper">
                    <label for="fotos_substituicao" class="file-input-label" tabindex="0" role="button" aria-controls="file-preview-substituicao">
                        <span class="upload-icon">üì∑</span><span class="upload-text">Clique para selecionar imagens</span>
                    </label>
                    <input type="file" id="fotos_substituicao" multiple accept="image/*">
                </div>
                <div class="file-preview" id="file-preview-substituicao"></div>
                <div class="upload-label" style="margin-top: 15px;"><span class="icon">üìù</span><span>Observa√ß√µes - Substitui√ß√£o</span></div>
                <textarea id="obs_substituicao" class="textarea-input" placeholder="Ex: L√¢mpadas queimadas..."></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submit-button">Enviar Relat√≥rio</button>
            <div id="status-messages"></div>
        </form>
    </div>

    <div class="footer">
        ¬© 2025 - Sistema de Relat√≥rios Internos
    </div>
</div>

<script>

// --- Fun√ß√µes e L√≥gica do Formul√°rio ---
const form = document.getElementById("uploadForm");
const submitButton = document.getElementById("submit-button");
const statusMessages = document.getElementById("status-messages");
// IDs dos campos de arquivo usados para valida√ß√£o global
const FILE_INPUT_IDS = ['fotos_pintura', 'fotos_reparo', 'fotos_substituicao'];

// Fun√ß√£o para converter um arquivo para o formato Base64
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Fun√ß√£o auxiliar para processar um grupo de arquivos
async function processFiles(fileInputId) {
    const fileInput = document.getElementById(fileInputId);
    const files = fileInput.files;
    const base64Array = [];
    for (const file of files) {
        const base64String = await toBase64(file);
        base64Array.push(base64String);
    }
    return base64Array;
}

// Fun√ß√£o para formatar bytes em texto leg√≠vel
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Valida√ß√£o do tamanho total de todos os arquivos selecionados
function validateTotalFiles() {
    const LIMIT = 25 * 1024 * 1024; // 25 MB
    let total = 0;
    FILE_INPUT_IDS.forEach(id => {
        const input = document.getElementById(id);
        if (input && input.files && input.files.length) {
            for (const f of input.files) total += f.size;
        }
    });

    // Mensagem de aviso persistente na √°rea de status
    const existing = document.getElementById('file-size-warning');
    if (total > LIMIT) {
        if (!existing) {
            const warn = document.createElement('div');
            warn.id = 'file-size-warning';
            warn.style.marginTop = '12px';
            warn.style.padding = '12px';
            warn.style.borderRadius = '8px';
            warn.style.background = '#fff3e0';
            warn.style.color = '#e65100';
            warn.style.fontWeight = '600';
            warn.textContent = `Tamanho total dos arquivos: ${formatBytes(total)} ‚Äî excede o limite de ${formatBytes(LIMIT)}. Remova alguns arquivos.`;
            statusMessages.appendChild(warn);
        } else {
            existing.textContent = `Tamanho total dos arquivos: ${formatBytes(total)} ‚Äî excede o limite de ${formatBytes(LIMIT)}. Remova alguns arquivos.`;
        }
        submitButton.disabled = true;
        return false;
    } else {
        if (existing) existing.remove();
        submitButton.disabled = false;
        return true;
    }
}

// Fun√ß√£o para configurar o feedback visual para cada input de arquivo
function setupFileInput(inputId, previewId) {
    const input = document.getElementById(inputId);
    const label = document.querySelector(`label[for="${inputId}"]`) || input.previousElementSibling;
    const previewBox = document.getElementById(previewId);

    input.addEventListener("change", () => {
        const files = Array.from(input.files || []);
        if (files.length > 0) {
            label.classList.add("has-file");
            previewBox.classList.add("show");
            // Build preview content
            const info = document.createElement('div');
            info.innerHTML = `<strong>${files.length} arquivo(s) selecionado(s)</strong>`;

            const filesRow = document.createElement('div');
            filesRow.className = 'files-row';

            // show up to 8 thumbnails to avoid heavy DOM
            files.slice(0, 8).forEach(file => {
                const thumbWrap = document.createElement('div');
                thumbWrap.className = 'thumb';
                const img = document.createElement('img');
                const reader = new FileReader();
                reader.onload = (e) => { img.src = e.target.result; };
                reader.readAsDataURL(file);
                thumbWrap.appendChild(img);
                filesRow.appendChild(thumbWrap);
            });

            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            const totalSize = files.reduce((s, f) => s + f.size, 0);
            fileInfo.innerHTML = `${files.map(f => `<div>${f.name} ‚Äî ${formatBytes(f.size)}</div>`).join('')}<div style="margin-top:6px;font-weight:600;">Total: ${formatBytes(totalSize)}</div>`;

            previewBox.innerHTML = '';
            previewBox.appendChild(info);
            previewBox.appendChild(filesRow);
            previewBox.appendChild(fileInfo);
        } else {
            label.classList.remove("has-file");
            previewBox.classList.remove("show");
            previewBox.innerHTML = "";
        }

        // revalida o total de arquivos e habilita/desabilita envio
        validateTotalFiles();
    });

    // keyboard support: Enter/Space to open file picker
    label.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            input.click();
        }
    });
}

// Configura os 3 campos de upload de arquivo
setupFileInput('fotos_pintura', 'file-preview-pintura');
setupFileInput('fotos_reparo', 'file-preview-reparo');
setupFileInput('fotos_substituicao', 'file-preview-substituicao');

// Evento que dispara quando o formul√°rio √© enviado
form.addEventListener("submit", async (event) => {
    event.preventDefault();
    if (webhookUrl === "https://bemol.app.n8n.cloud/webhook/visita" || webhookUrl === "") {
        alert("üö® ERRO: A URL do Power Automate n√£o foi configurada no c√≥digo JavaScript!");
        return;
    }

    submitButton.disabled = true;
    statusMessages.innerHTML = `<div class="loading show">Enviando relat√≥rio, por favor aguarde...</div>`;

    try {
        // Antes de enviar, revalida o tamanho total (pode ter mudado)
        if (!validateTotalFiles()) throw new Error('Tamanho total dos arquivos excede o limite.');

        // Monta FormData para enviar arquivos bin√°rios sem alterar qualidade
        const formData = new FormData();
        formData.append('LOJA', document.getElementById("loja").value);
        formData.append('DATA_VISITA', document.getElementById("data_visita").value);
        formData.append('TECNICO', document.getElementById("tecnico").value);
        formData.append('OBS_PINTURA', document.getElementById("obs_pintura").value);
        formData.append('OBS_REPARO', document.getElementById("obs_reparo").value);
        formData.append('OBS_SUBSTITUICAO', document.getElementById("obs_substituicao").value);

        // Anexa os arquivos como arrays (mantendo nomes de campo simples)
        const appendFiles = (inputId, fieldName) => {
            const input = document.getElementById(inputId);
            if (input && input.files) {
                Array.from(input.files).forEach(file => {
                    formData.append(fieldName, file, file.name);
                });
            }
        };

    // Use field names without brackets to improve compatibility with n8n webhook parsing
    appendFiles('fotos_pintura', 'fotos_pintura');
    appendFiles('fotos_reparo', 'fotos_reparo');
    appendFiles('fotos_substituicao', 'fotos_substituicao');

        const response = await fetch(webhookUrl, {
            method: "POST",
            body: formData // n√£o definir Content-Type ‚Äî o browser monta o boundary automaticamente
        });

        if (!response.ok) {
            // tenta ler o corpo da resposta para debug (pode conter mensagem do servidor)
            let text = '';
            try { text = await response.text(); } catch (e) { text = ''; }
            throw new Error(`Erro do servidor: ${response.status} ${text ? '\nResposta: ' + text : ''}`);
        }

        statusMessages.innerHTML = `<div class="success-message show">‚úÖ Relat√≥rio enviado com sucesso!</div>`;
        form.reset();
        // Limpa os previews dos arquivos
        document.querySelectorAll('.file-preview').forEach(p => { p.innerHTML = ''; p.classList.remove('show'); });
        document.querySelectorAll('.file-input-label').forEach(l => l.classList.remove('has-file'));

    } catch (error) {
        console.error("Erro ao enviar o formul√°rio:", error);
        statusMessages.innerHTML = "";
        alert(`‚ùå Ocorreu um erro ao enviar o relat√≥rio. Verifique sua conex√£o.\n\nDetalhes: ${error.message}`);
    } finally {
        submitButton.disabled = false;
        setTimeout(() => {
            if (statusMessages.querySelector('.success-message')) {
                statusMessages.innerHTML = '';
            }
        }, 5000);
    }
});
</script>

</body>
</html>




