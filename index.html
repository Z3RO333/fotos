<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Visita T√©cnica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .form-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        label.required::after {
            content: " *";
            color: #dc3545;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        /* Estilos para categorias com upload */
        .categoria-item {
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .categoria-item:hover {
            border-color: #667eea;
        }

        .categoria-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .categoria-header:hover {
            background: #e9ecef;
        }

        .categoria-header input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 12px;
            cursor: pointer;
        }

        .categoria-header label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }

        .categoria-content {
            padding: 15px;
            background: white;
            border-top: 2px solid #e0e0e0;
        }

        .categoria-content textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            resize: vertical;
        }

        .mini-upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .mini-upload-area:hover {
            background: #e9ecff;
            border-color: #764ba2;
        }

        .upload-label {
            color: #667eea;
            font-weight: 600;
        }

        .foto-preview-mini {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .foto-preview-mini .foto-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .foto-preview-mini .foto-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .foto-preview-mini .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .foto-preview-mini .remove-btn:hover {
            background: #c82333;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            background: #e9ecff;
            border-color: #764ba2;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .foto-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .foto-preview-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .foto-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .foto-preview-item .foto-info {
            padding: 10px;
            background: #f8f9fa;
        }

        .foto-preview-item .foto-info input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .foto-preview-item .remove-foto {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: all 0.3s;
        }

        .foto-preview-item .remove-foto:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .status-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .status-option {
            flex: 1;
            padding: 15px;
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .status-option input[type="radio"] {
            display: none;
        }

        .status-option.ok {
            border-color: #28a745;
        }

        .status-option.atencao {
            border-color: #ffc107;
        }

        .status-option.critico {
            border-color: #dc3545;
        }

        .status-option input:checked + label {
            font-weight: bold;
        }

        .status-option.ok input:checked ~ * {
            background: #d4edda;
        }

        .status-option.atencao input:checked ~ * {
            background: #fff3cd;
        }

        .status-option.critico input:checked ~ * {
            background: #f8d7da;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Relat√≥rio de Visita T√©cnica</h1>
            <p>Preencha todos os campos obrigat√≥rios (*)</p>
        </div>

        <div class="form-content">
            <div id="alertContainer"></div>

            <form id="formVisita">
                <!-- SE√á√ÉO 1: DADOS DA UNIDADE -->
                <div class="section">
                    <h2 class="section-title">üè¢ Informa√ß√µes da Unidade</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="codigoLoja" class="required">C√≥digo da Loja</label>
                            <input type="text" id="codigoLoja" name="codigoLoja" 
                                   placeholder="Ex: LJ-089" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="nomeLoja" class="required">Nome da Unidade</label>
                            <input type="text" id="nomeLoja" name="nomeLoja" 
                                   placeholder="Ex: Bemol Manaus Centro" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade" class="required">Cidade</label>
                            <input type="text" id="cidade" name="cidade" 
                                   placeholder="Ex: Manaus" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipoUnidade" class="required">Tipo de Unidade</label>
                            <select id="tipoUnidade" name="tipoUnidade" required>
                                <option value="">Selecione...</option>
                                <option value="Loja">Loja</option>
                                <option value="CD">Centro de Distribui√ß√£o</option>
                                <option value="Farmacia">Farm√°cia</option>
                                <option value="Matriz">Matriz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 2: DADOS DA VISITA -->
                <div class="section">
                    <h2 class="section-title">üë§ Dados da Visita</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeVisitante" class="required">Nome do Visitante</label>
                            <input type="text" id="nomeVisitante" name="nomeVisitante" 
                                   placeholder="Seu nome completo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailVisitante" class="required">E-mail</label>
                            <input type="email" id="emailVisitante" name="emailVisitante" 
                                   placeholder="seu.email@empresa.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="area" class="required">√Årea</label>
                            <select id="area" name="area" required>
                                <option value="">Selecione...</option>
                                <option value="Facilities">Facilities</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="TI">TI</option>
                                <option value="Seguran√ßa">Seguran√ßa</option>
                                <option value="Qualidade">Qualidade</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipoVisita" class="required">Tipo de Visita</label>
                            <select id="tipoVisita" name="tipoVisita" required>
                                <option value="">Selecione...</option>
                                <option value="Inspe√ß√£o Mensal">Inspe√ß√£o Mensal</option>
                                <option value="Checklist">Checklist</option>
                                <option value="P√≥s-Obra">P√≥s-Obra</option>
                                <option value="Auditoria">Auditoria</option>
                                <option value="Emerg√™ncia">Emerg√™ncia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataVisita" class="required">Data da Visita</label>
                            <input type="date" id="dataVisita" name="dataVisita" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="horaVisita" class="required">Hora da Visita</label>
                            <input type="time" id="horaVisita" name="horaVisita" required>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 3: AVALIA√á√ÉO -->
                <div class="section">
                    <h2 class="section-title">üìä Avalia√ß√£o Geral</h2>
                    
                    <div class="form-group">
                        <label class="required">Status Geral da Unidade</label>
                        <div class="status-selector">
                            <div class="status-option ok">
                                <input type="radio" id="statusOk" name="statusGeral" value="OK" required>
                                <label for="statusOk">
                                    <div style="font-size: 30px; margin-bottom: 5px;">‚úì</div>
                                    <div>OK</div>
                                </label>
                            </div>
                            
                            <div class="status-option atencao">
                                <input type="radio" id="statusAtencao" name="statusGeral" value="Aten√ß√£o">
                                <label for="statusAtencao">
                                    <div style="font-size: 30px; margin-bottom: 5px;">‚ö†</div>
                                    <div>Aten√ß√£o</div>
                                </label>
                            </div>
                            
                            <div class="status-option critico">
                                <input type="radio" id="statusCritico" name="statusGeral" value="Cr√≠tico">
                                <label for="statusCritico">
                                    <div style="font-size: 30px; margin-bottom: 5px;">‚úï</div>
                                    <div>Cr√≠tico</div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pontos Avaliados (selecione e anexe fotos)</label>

                        <!-- Sistema El√©trico -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto1" name="pontosAvaliados" value="Sistema El√©trico">
                                <label for="ponto1">‚ö° Sistema El√©trico</label>
                            </div>
                            <div class="categoria-content" id="content-ponto1" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Sistema El√©trico..." id="obs-ponto1" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto1">
                                    <input type="file" id="foto-ponto1" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto1"></div>
                            </div>
                        </div>

                        <!-- Climatiza√ß√£o -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto2" name="pontosAvaliados" value="Climatiza√ß√£o">
                                <label for="ponto2">‚ùÑÔ∏è Climatiza√ß√£o</label>
                            </div>
                            <div class="categoria-content" id="content-ponto2" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Climatiza√ß√£o..." id="obs-ponto2" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto2">
                                    <input type="file" id="foto-ponto2" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto2"></div>
                            </div>
                        </div>

                        <!-- Limpeza Geral -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto3" name="pontosAvaliados" value="Limpeza Geral">
                                <label for="ponto3">üßπ Limpeza Geral</label>
                            </div>
                            <div class="categoria-content" id="content-ponto3" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Limpeza..." id="obs-ponto3" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto3">
                                    <input type="file" id="foto-ponto3" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto3"></div>
                            </div>
                        </div>

                        <!-- Layout e Sinaliza√ß√£o -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto4" name="pontosAvaliados" value="Layout e Sinaliza√ß√£o">
                                <label for="ponto4">üèóÔ∏è Layout e Sinaliza√ß√£o</label>
                            </div>
                            <div class="categoria-content" id="content-ponto4" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Layout e Sinaliza√ß√£o..." id="obs-ponto4" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto4">
                                    <input type="file" id="foto-ponto4" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto4"></div>
                            </div>
                        </div>

                        <!-- Equipamentos TI -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto5" name="pontosAvaliados" value="Equipamentos TI">
                                <label for="ponto5">üíª Equipamentos TI</label>
                            </div>
                            <div class="categoria-content" id="content-ponto5" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Equipamentos TI..." id="obs-ponto5" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto5">
                                    <input type="file" id="foto-ponto5" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto5"></div>
                            </div>
                        </div>

                        <!-- Seguran√ßa -->
                        <div class="categoria-item">
                            <div class="categoria-header">
                                <input type="checkbox" id="ponto6" name="pontosAvaliados" value="Seguran√ßa">
                                <label for="ponto6">üõ°Ô∏è Seguran√ßa</label>
                            </div>
                            <div class="categoria-content" id="content-ponto6" style="display: none;">
                                <textarea placeholder="Observa√ß√µes sobre Seguran√ßa..." id="obs-ponto6" rows="2"></textarea>
                                <div class="mini-upload-area" data-categoria="ponto6">
                                    <input type="file" id="foto-ponto6" accept="image/*" multiple style="display: none;">
                                    <div class="upload-label">üì∑ Clique para adicionar fotos</div>
                                </div>
                                <div class="foto-preview-mini" id="preview-ponto6"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes Gerais</label>
                        <textarea id="observacoes" name="observacoes" 
                                  placeholder="Descreva detalhes da visita, pontos de aten√ß√£o, etc."></textarea>
                    </div>
                </div>

                <!-- SE√á√ÉO 4: A√á√ïES -->
                <div class="section">
                    <h2 class="section-title">‚ö° A√ß√µes Necess√°rias</h2>
                    
                    <div class="form-group">
                        <label for="acoesNecessarias">Descreva as A√ß√µes</label>
                        <textarea id="acoesNecessarias" name="acoesNecessarias" 
                                  placeholder="Liste as a√ß√µes que precisam ser tomadas..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="prazo">Prazo Recomendado</label>
                            <input type="text" id="prazo" name="prazo" 
                                   placeholder="Ex: 15 dias">
                        </div>
                        
                        <div class="form-group">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia" selected>M√©dia</option>
                                <option value="Alta">Alta</option>
                                <option value="Cr√≠tica">Cr√≠tica</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO 5: FOTOS GERAIS (OPCIONAL) -->
                <div class="section">
                    <h2 class="section-title">üì∏ Fotos Gerais (Opcional)</h2>
                    <p style="color: #6c757d; margin-bottom: 15px;">Use esta se√ß√£o para fotos adicionais que n√£o se encaixam nas categorias acima.</p>

                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="fotosInput" accept="image/*" multiple>
                        <div style="font-size: 50px; margin-bottom: 15px;">üì∑</div>
                        <h3>Clique ou arraste fotos aqui</h3>
                        <p style="color: #6c757d; margin-top: 10px;">Aceita JPG, PNG (m√°x 30 fotos)</p>
                    </div>

                    <div class="foto-preview-container" id="fotoPreviewContainer"></div>
                </div>

                <!-- BOT√ÉO ENVIAR -->
                <button type="submit" class="btn-submit" id="btnSubmit">
                    üì§ Enviar Relat√≥rio
                </button>

                <div class="loading" id="loadingDiv">
                    <div class="spinner"></div>
                    <p>Processando seu relat√≥rio... Por favor, aguarde.</p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ÉO ==========
        const CONFIG = {
            
            //  Power Automate Webhook
            webhookUrl: 'https://defaultf10f91e5f90548aa8c4ca68d0ae5f6.ec.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/889cae83ca8547409d6d71a6d32c0ee9/triggers/manual/paths/invoke?api-version=1', 
            
    
            
            maxFotos: 30,
            maxTamanhoFoto: 5 * 1024 * 1024 // 5MB
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let fotosArray = [];
        let fotosPorCategoria = {
            ponto1: [],
            ponto2: [],
            ponto3: [],
            ponto4: [],
            ponto5: [],
            ponto6: []
        };

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Data e hora padr√£o = agora
            const hoje = new Date();
            document.getElementById('dataVisita').valueAsDate = hoje;
            document.getElementById('horaVisita').value = hoje.toTimeString().slice(0,5);

            // Checkboxes de categoria - mostrar/ocultar conte√∫do
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`ponto${i}`);
                const content = document.getElementById(`content-ponto${i}`);

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        content.style.display = 'block';
                    } else {
                        content.style.display = 'none';
                    }
                });

                // Upload de fotos por categoria
                const uploadArea = document.querySelector(`[data-categoria="ponto${i}"]`);
                const fileInput = document.getElementById(`foto-ponto${i}`);

                uploadArea.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (e) => {
                    handleFilesCategoria(e.target.files, `ponto${i}`);
                });
            }

            // Upload de fotos gerais (mantido)
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fotosInput = document.getElementById('fotosInput');

            fileUploadArea.addEventListener('click', () => fotosInput.click());

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.style.background = '#d5d9ff';
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.style.background = '#f8f9ff';
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.style.background = '#f8f9ff';
                handleFiles(e.dataTransfer.files);
            });

            fotosInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Status selector styling
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });

            // Submit do formul√°rio
            document.getElementById('formVisita').addEventListener('submit', handleSubmit);
        });

        // ========== FUN√á√ïES DE UPLOAD DE FOTOS ==========
        // Upload de fotos por categoria
        function handleFilesCategoria(files, categoria) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showAlert(`${file.name} n√£o √© uma imagem v√°lida`, 'error');
                    return;
                }

                if (file.size > CONFIG.maxTamanhoFoto) {
                    showAlert(`${file.name} excede o tamanho m√°ximo de 5MB`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const foto = {
                        nome: file.name,
                        base64: e.target.result.split(',')[1],
                        preview: e.target.result
                    };
                    fotosPorCategoria[categoria].push(foto);
                    renderFotoCategoria(categoria);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderFotoCategoria(categoria) {
            const container = document.getElementById(`preview-${categoria}`);
            container.innerHTML = '';

            fotosPorCategoria[categoria].forEach((foto, index) => {
                const div = document.createElement('div');
                div.className = 'foto-item';
                div.innerHTML = `
                    <button type="button" class="remove-btn" onclick="removeFotoCategoria('${categoria}', ${index})">&times;</button>
                    <img src="${foto.preview}" alt="${foto.nome}">
                `;
                container.appendChild(div);
            });
        }

        function removeFotoCategoria(categoria, index) {
            fotosPorCategoria[categoria].splice(index, 1);
            renderFotoCategoria(categoria);
        }

        // Upload de fotos gerais (mantido)
        function handleFiles(files) {
            if (fotosArray.length + files.length > CONFIG.maxFotos) {
                showAlert(`M√°ximo de ${CONFIG.maxFotos} fotos permitidas`, 'error');
                return;
            }

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showAlert(`${file.name} n√£o √© uma imagem v√°lida`, 'error');
                    return;
                }

                if (file.size > CONFIG.maxTamanhoFoto) {
                    showAlert(`${file.name} excede o tamanho m√°ximo de 5MB`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const foto = {
                        nome: file.name,
                        base64: e.target.result.split(',')[1],
                        comentario: '',
                        preview: e.target.result
                    };
                    fotosArray.push(foto);
                    renderFotoPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderFotoPreview() {
            const container = document.getElementById('fotoPreviewContainer');
            container.innerHTML = '';

            fotosArray.forEach((foto, index) => {
                const div = document.createElement('div');
                div.className = 'foto-preview-item';
                div.innerHTML = `
                    <button type="button" class="remove-foto" onclick="removeFoto(${index})">&times;</button>
                    <img src="${foto.preview}" alt="${foto.nome}">
                    <div class="foto-info">
                        <input type="text" placeholder="Coment√°rio da foto (opcional)" 
                               value="${foto.comentario}" 
                               onchange="updateComentario(${index}, this.value)">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function removeFoto(index) {
            fotosArray.splice(index, 1);
            renderFotoPreview();
        }

        function updateComentario(index, valor) {
            fotosArray[index].comentario = valor;
        }

        // ========== SUBMIT DO FORMUL√ÅRIO ==========
        async function handleSubmit(e) {
            e.preventDefault();

            // Valida√ß√µes
            if (!validarFormulario()) {
                return;
            }

            // Desabilitar bot√£o
            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            document.getElementById('loadingDiv').classList.add('active');

            try {
                // Montar JSON
                const dados = montarJSON();

                // Enviar para webhook
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const resultado = await response.json();

                // Sucesso!
                showAlert('‚úÖ Relat√≥rio enviado com sucesso! Voc√™ receber√° um e-mail em breve.', 'success');

                // Limpar formul√°rio
                setTimeout(() => {
                    document.getElementById('formVisita').reset();
                    fotosArray = [];
                    renderFotoPreview();

                    // Limpar fotos por categoria
                    for (let i = 1; i <= 6; i++) {
                        fotosPorCategoria[`ponto${i}`] = [];
                        renderFotoCategoria(`ponto${i}`);
                        document.getElementById(`content-ponto${i}`).style.display = 'none';
                    }

                    window.scrollTo(0, 0);
                }, 2000);

            } catch (error) {
                console.error('Erro ao enviar:', error);
                showAlert('‚ùå Erro ao enviar relat√≥rio. Tente novamente ou contate o suporte.', 'error');
            } finally {
                btnSubmit.disabled = false;
                document.getElementById('loadingDiv').classList.remove('active');
            }
        }

        function validarFormulario() {
            const camposObrigatorios = [
                'codigoLoja', 'nomeLoja', 'cidade', 'tipoUnidade',
                'nomeVisitante', 'emailVisitante', 'area', 'tipoVisita',
                'dataVisita', 'horaVisita'
            ];

            for (let campo of camposObrigatorios) {
                const elemento = document.getElementById(campo);
                if (!elemento.value.trim()) {
                    showAlert(`Campo obrigat√≥rio n√£o preenchido: ${elemento.previousElementSibling.textContent}`, 'error');
                    elemento.focus();
                    return false;
                }
            }

            const statusGeral = document.querySelector('input[name="statusGeral"]:checked');
            if (!statusGeral) {
                showAlert('Selecione o status geral da unidade', 'error');
                return false;
            }

            return true;
        }

        function montarJSON() {
            // Pegar valores do formul√°rio
            const formData = new FormData(document.getElementById('formVisita'));

            // Pontos avaliados (checkboxes) com observa√ß√µes e fotos
            const pontosAvaliados = [];
            const categorias = {
                ponto1: 'Sistema El√©trico',
                ponto2: 'Climatiza√ß√£o',
                ponto3: 'Limpeza Geral',
                ponto4: 'Layout e Sinaliza√ß√£o',
                ponto5: 'Equipamentos TI',
                ponto6: 'Seguran√ßa'
            };

            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`ponto${i}`);
                if (checkbox && checkbox.checked) {
                    const categoria = `ponto${i}`;
                    const observacao = document.getElementById(`obs-${categoria}`).value;
                    const fotos = fotosPorCategoria[categoria].map(f => ({
                        nome: f.nome,
                        base64: f.base64
                    }));

                    pontosAvaliados.push({
                        item: categorias[categoria],
                        observacao: observacao || 'Sem observa√ß√µes.',
                        fotos: fotos
                    });
                }
            }

            // Montar objeto completo
            const dados = {
                id_resposta: `FORM-${Date.now()}`,
                timestamp: new Date().toISOString(),
                loja: {
                    codigo: formData.get('codigoLoja'),
                    nome: formData.get('nomeLoja'),
                    cidade: formData.get('cidade'),
                    tipo: formData.get('tipoUnidade'),
                    email: '' // Ser√° buscado pelo backend
                },
                visita: {
                    responsavel: formData.get('emailVisitante'),
                    nome_responsavel: formData.get('nomeVisitante'),
                    area: formData.get('area'),
                    data: formData.get('dataVisita'),
                    hora: formData.get('horaVisita'),
                    tipo_visita: formData.get('tipoVisita')
                },
                avaliacao: {
                    status_geral: formData.get('statusGeral'),
                    pontos_avaliados: pontosAvaliados,
                    observacoes: formData.get('observacoes') || 'Nenhuma observa√ß√£o adicional.'
                },
                acoes: {
                    necessarias: formData.get('acoesNecessarias') || 'Nenhuma a√ß√£o necess√°ria no momento.',
                    prazo: formData.get('prazo') || 'N/A',
                    prioridade: formData.get('prioridade')
                },
                fotos_gerais: fotosArray.map(f => ({
                    nome: f.nome,
                    base64: f.base64,
                    comentario: f.comentario
                })),
                config: {
                    incluir_pdf: true,
                    template: 'padrao_visita'
                }
            };

            return dados;
        }

        function showAlert(mensagem, tipo) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} show`;
            alertDiv.textContent = mensagem;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
